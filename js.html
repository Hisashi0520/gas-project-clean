<script>
/**
 * æœˆå ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.5.2 - JavaScript
 * 
 * ã€v1.5.2 å¤‰æ›´å†…å®¹ã€‘
 * - æå‡ºçŠ¶æ³è¡¨ç¤ºã‚’ getSubmissionStatusSimple ã«å¤‰æ›´
 * - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–
 */

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentUser = null;
let currentTemplate = [];
let attachmentData = {};
let currentReportStatus = null;

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', function() {
  loadUsers();
  loadMonthOptions();
});

// ===== ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ =====
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  document.getElementById(pageId).classList.add('active');
}

function showMainPage() {
  showPage('mainPage');
}

function showInputPage() {
  showPage('inputPage');
  loadTemplate();
}

function showViewPage() {
  showPage('viewPage');
  document.getElementById('viewYearMonth').innerHTML = document.getElementById('yearMonthSelect').innerHTML;
  document.getElementById('viewYearMonth').value = document.getElementById('yearMonthSelect').value;
  
  google.script.run
    .withSuccessHandler(function(users) {
      const select = document.getElementById('viewUser');
      select.innerHTML = '<option value="">å…¨å“¡</option>';
      users.forEach(user => {
        select.innerHTML += `<option value="${user.employeeId}">${user.name}</option>`;
      });
      loadReportsForView();
    })
    .getActiveUsers();
}

function showStatusPage() {
  showPage('statusPage');
  document.getElementById('statusYearMonth').innerHTML = document.getElementById('yearMonthSelect').innerHTML;
  document.getElementById('statusYearMonth').value = document.getElementById('yearMonthSelect').value;
  loadSubmissionStatus();
}

// ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° =====
function showLoading() {
  document.getElementById('loading').classList.add('active');
}

function hideLoading() {
  document.getElementById('loading').classList.remove('active');
}

// ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ =====
function loadUsers() {
  google.script.run
    .withSuccessHandler(function(users) {
      const select = document.getElementById('userSelect');
      users.forEach(user => {
        select.innerHTML += `<option value="${user.employeeId}">${user.name}</option>`;
      });
    })
    .withFailureHandler(function(error) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    })
    .getActiveUsers();
}

function login() {
  const employeeId = document.getElementById('userSelect').value;
  const password = document.getElementById('password').value;
  
  if (!employeeId) {
    document.getElementById('loginError').textContent = 'åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
    return;
  }
  
  if (!password || password.length !== 4) {
    document.getElementById('loginError').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        currentUser = result.user;
        document.getElementById('currentUserName').textContent = currentUser.name + ' ã•ã‚“';
        document.getElementById('loginError').textContent = '';
        showPage('mainPage');
      } else {
        document.getElementById('loginError').textContent = result.message;
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      document.getElementById('loginError').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
      console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    })
    .authenticate(employeeId, password);
}

function logout() {
  currentUser = null;
  currentTemplate = [];
  attachmentData = {};
  currentReportStatus = null;
  document.getElementById('password').value = '';
  showPage('loginPage');
}

// ===== å¹´æœˆé¸æŠ =====
function loadMonthOptions() {
  google.script.run
    .withSuccessHandler(function(months) {
      const selects = ['yearMonthSelect', 'viewYearMonth', 'statusYearMonth'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '';
          months.forEach(month => {
            select.innerHTML += `<option value="${month}">${month}</option>`;
          });
        }
      });
    })
    .getAvailableMonths();
}

// ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»å…¥åŠ› =====
function loadTemplate() {
  if (!currentUser) return;
  
  const yearMonth = document.getElementById('yearMonthSelect').value;
  document.getElementById('inputPageTitle').textContent = yearMonth + ' æœˆå ±å…¥åŠ›';
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(statusResult) {
      currentReportStatus = statusResult;
      showStatusWarning(statusResult, yearMonth);
      
      google.script.run
        .withSuccessHandler(function(template) {
          currentTemplate = template;
          
          google.script.run
            .withSuccessHandler(function(existingData) {
              hideLoading();
              renderQuestions(template, existingData);
            })
            .withFailureHandler(function(error) {
              hideLoading();
              renderQuestions(template, []);
            })
            .getReportData(currentUser.employeeId, yearMonth);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getTemplate(currentUser.templateId);
    })
    .withFailureHandler(function(error) {
      currentReportStatus = { hasData: false, isSubmitted: false };
      hideStatusWarning();
      
      google.script.run
        .withSuccessHandler(function(template) {
          currentTemplate = template;
          google.script.run
            .withSuccessHandler(function(existingData) {
              hideLoading();
              renderQuestions(template, existingData);
            })
            .withFailureHandler(function(error) {
              hideLoading();
              renderQuestions(template, []);
            })
            .getReportData(currentUser.employeeId, yearMonth);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        })
        .getTemplate(currentUser.templateId);
    })
    .getReportStatus(currentUser.employeeId, yearMonth);
}

function showStatusWarning(statusResult, yearMonth) {
  let warningDiv = document.getElementById('statusWarning');
  
  if (!warningDiv) {
    warningDiv = document.createElement('div');
    warningDiv.id = 'statusWarning';
    const form = document.getElementById('reportForm');
    form.parentNode.insertBefore(warningDiv, form);
  }
  
  if (statusResult.isSubmitted) {
    warningDiv.innerHTML = `
      <div class="warning-box warning-submitted">
        <strong>âš ï¸ ã“ã®æœˆã¯æ—¢ã«æå‡ºæ¸ˆã¿ã§ã™</strong><br>
        ${yearMonth} ã®æœˆå ±ã¯æå‡ºæ¸ˆã¿ã§ã™ã€‚ç·¨é›†ã—ã¦å†æå‡ºã™ã‚‹ã¨ã€å‰å›ã®å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
      </div>
    `;
    warningDiv.style.display = 'block';
  } else if (statusResult.hasData) {
    warningDiv.innerHTML = `
      <div class="warning-box warning-draft">
        <strong>ğŸ“ ä¸‹æ›¸ããŒã‚ã‚Šã¾ã™</strong><br>
        ${yearMonth} ã®æœˆå ±ã«ã¯ä¿å­˜æ¸ˆã¿ã®ä¸‹æ›¸ããŒã‚ã‚Šã¾ã™ã€‚
      </div>
    `;
    warningDiv.style.display = 'block';
  } else {
    warningDiv.style.display = 'none';
  }
}

function hideStatusWarning() {
  const warningDiv = document.getElementById('statusWarning');
  if (warningDiv) {
    warningDiv.style.display = 'none';
  }
}

function renderQuestions(template, existingData) {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = '';
  attachmentData = {};
  
  template.forEach((q, index) => {
    const existingAnswer = existingData.find(d => d.questionNo === q.questionNo);
    
    const html = `
      <div class="question-item">
        <div class="question-title">${q.title}</div>
        <div class="question-description">${q.description}</div>
        
        <div class="form-group">
          <label>å›ç­”</label>
          <textarea id="answer_${index}" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚">${existingAnswer ? existingAnswer.answer : ''}</textarea>
        </div>
        
        ${q.allowAttachment ? `
        <div class="file-upload">
          <input type="file" id="file_${index}" onchange="handleFileSelect(${index}, this)">
          <label for="file_${index}">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã™ã‚‹</label>
          <div class="file-name" id="fileName_${index}">${existingAnswer && existingAnswer.attachmentUrl ? 'æ·»ä»˜æ¸ˆã¿: ' + existingAnswer.attachmentUrl : ''}</div>
        </div>
        ` : ''}
      </div>
    `;
    
    container.innerHTML += html;
  });
}

function handleFileSelect(index, input) {
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64 = e.target.result.split(',')[1];
      attachmentData[index] = {
        data: base64,
        name: file.name
      };
      document.getElementById('fileName_' + index).textContent = 'é¸æŠä¸­: ' + file.name;
    };
    reader.readAsDataURL(file);
  }
}

// ===== ä¿å­˜ãƒ»æå‡º =====
function saveDraft() {
  saveReport('ä¸‹æ›¸ã');
}

function submitReport() {
  if (currentReportStatus && currentReportStatus.isSubmitted) {
    if (!confirm('âš ï¸ ã“ã®æœˆå ±ã¯æ—¢ã«æå‡ºæ¸ˆã¿ã§ã™ã€‚\n\nä¸Šæ›¸ãã—ã¦å†æå‡ºã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå‰å›ã®å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰')) {
      return;
    }
  } else {
    if (!confirm('æœˆå ±ã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
  }
  
  saveReport('æå‡ºæ¸ˆ');
}

function saveReport(status) {
  const yearMonth = document.getElementById('yearMonthSelect').value;
  showLoading();
  processAnswersWithAttachments(yearMonth, status);
}

async function processAnswersWithAttachments(yearMonth, status) {
  const answers = [];
  
  for (let i = 0; i < currentTemplate.length; i++) {
    const q = currentTemplate[i];
    const answerText = document.getElementById('answer_' + i).value;
    
    let attachmentUrl = '';
    let attachmentText = '';
    
    if (attachmentData[i]) {
      try {
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .saveAttachment(
              attachmentData[i].data,
              attachmentData[i].name,
              yearMonth,
              currentUser.employeeId,
              currentUser.name
            );
        });
        
        if (result.success) {
          attachmentUrl = result.folderUrl;
          attachmentText = result.extractedText;
        }
      } catch (error) {
        console.error('æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    answers.push({
      questionNo: q.questionNo,
      questionTitle: q.title,
      answer: answerText,
      attachmentUrl: attachmentUrl,
      attachmentText: attachmentText
    });
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        alert(result.message);
        showMainPage();
      } else {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    })
    .saveReport({
      yearMonth: yearMonth,
      employeeId: currentUser.employeeId,
      userName: currentUser.name,
      status: status,
      answers: answers
    });
}

// ===== é–²è¦§ =====
function loadReportsForView() {
  const yearMonth = document.getElementById('viewYearMonth').value;
  const employeeId = document.getElementById('viewUser').value;
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(reports) {
      hideLoading();
      renderReports(reports);
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    })
    .getReportsForView(yearMonth, employeeId || null);
}

function renderReports(reports) {
  const container = document.getElementById('reportsContainer');
  
  if (!reports || reports.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">è©²å½“ã™ã‚‹æœˆå ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    return;
  }
  
  let html = '';
  reports.forEach(report => {
    const statusClass = report.status === 'æå‡ºæ¸ˆ' ? 'status-submitted' : 'status-draft';
    
    html += `
      <div class="report-card">
        <div class="report-header">
          <h3>${report.name} - ${report.yearMonth}</h3>
          <span class="status-badge ${statusClass}">${report.status}</span>
        </div>
        <div class="report-body">
    `;
    
    report.questions.forEach(q => {
      html += `
        <div class="report-question">
          <div class="report-question-title">${q.questionTitle}</div>
          <div class="report-answer">${q.answer || 'ï¼ˆå›ç­”ãªã—ï¼‰'}</div>
          ${q.attachmentUrl ? `
          <div class="report-attachment">
            <a href="${q.attachmentUrl}" target="_blank">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>
          </div>
          ` : ''}
        </div>
      `;
    });
    
    html += '</div></div>';
  });
  
  container.innerHTML = html;
}

// ===== æå‡ºçŠ¶æ³ =====
function loadSubmissionStatus() {
  const yearMonth = document.getElementById('statusYearMonth').value;
  const container = document.getElementById('statusContainer');
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  container.innerHTML = '<p style="text-align: center; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
  
  google.script.run
    .withSuccessHandler(function(statusList) {
      console.log('æå‡ºçŠ¶æ³ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', statusList);
      renderSubmissionStatus(statusList);
    })
    .withFailureHandler(function(error) {
      console.error('æå‡ºçŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      container.innerHTML = '<p style="text-align: center; color: #d93025;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
    })
    .getSubmissionStatusSimple(yearMonth);
}

function renderSubmissionStatus(statusList) {
  const container = document.getElementById('statusContainer');
  
  // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
  if (!statusList || !Array.isArray(statusList)) {
    console.error('statusListãŒç„¡åŠ¹:', statusList);
    container.innerHTML = '<p style="text-align: center; color: #d93025;">ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚</p>';
    return;
  }
  
  if (statusList.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
    return;
  }
  
  let submittedCount = 0;
  statusList.forEach(s => {
    if (s.status === 'æå‡ºæ¸ˆ') {
      submittedCount++;
    }
  });
  
  let totalCount = statusList.length;
  
  let html = `
    <p style="margin-bottom: 16px;">æå‡ºæ¸ˆ: <strong>${submittedCount}</strong> / ${totalCount} å</p>
    <table class="status-table">
      <thead>
        <tr>
          <th>åå‰</th>
          <th>çŠ¶æ³</th>
          <th>æå‡ºæ—¥æ™‚</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  statusList.forEach(s => {
    const statusClass = s.status === 'æå‡ºæ¸ˆ' ? 'status-submitted' : 'status-pending';
    let submittedAt = '-';
    
    if (s.submittedAt) {
      try {
        submittedAt = new Date(s.submittedAt).toLocaleString('ja-JP');
      } catch (e) {
        submittedAt = String(s.submittedAt);
      }
    }
    
    html += `
      <tr>
        <td>${s.name || 'ï¼ˆåå‰ãªã—ï¼‰'}</td>
        <td><span class="status-badge ${statusClass}">${s.status || 'ä¸æ˜'}</span></td>
        <td>${submittedAt}</td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}
</script>

